<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - SportStore</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --admin-sidebar-bg: #2c3e50;
            --admin-sidebar-text: #ecf0f1;
            --admin-sidebar-active-bg: #34495e;
            --admin-sidebar-hover-bg: #3b5368;
            --admin-sidebar-heading: #95a5a6;
        }
        body.admin-page { display: block; }
        .admin-layout { display: flex; min-height: 100vh; }
        .admin-sidebar { 
            width: 260px; 
            background-color: var(--admin-sidebar-bg); 
            color: var(--admin-sidebar-text); 
            padding: 1.5rem 1rem; 
            flex-shrink: 0; 
            transition: width 0.3s ease;
        }
        .admin-sidebar-header { color: #fff; margin-bottom: 2rem; padding: 0 0.5rem; }
        .admin-sidebar-header h2 { margin: 0; font-size: 1.5rem; }
        .admin-nav .nav-group-heading { text-transform: uppercase; font-size: 0.75rem; font-weight: 600; color: var(--admin-sidebar-heading); padding: 1.5rem 0.8rem 0.5rem; letter-spacing: 0.5px; }
        .admin-nav .nav-link { display: flex; align-items: center; gap: 0.8rem; color: var(--admin-sidebar-text); padding: 0.8rem; border-radius: 8px; transition: all 0.2s; text-decoration: none; margin-bottom: 0.25rem; font-weight: 500; }
        .admin-nav .nav-link i { width: 20px; text-align: center; font-size: 1.1rem; opacity: 0.8; }
        .admin-nav .nav-link:hover { background-color: var(--admin-sidebar-hover-bg); color: #fff; }
        .admin-nav .nav-link.active { background-color: var(--admin-sidebar-active-bg); color: #fff; font-weight: 600; }
        .admin-main-content { flex-grow: 1; padding: 2rem; background-color: var(--color-background-light); position: relative; }
        .content-loader { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.8); display: flex; align-items: center; justify-content: center; z-index: 10; }
        .protected-content { display: none; }
        .table-wrapper { overflow-x: auto; }
        .product-table { width: 100%; border-collapse: collapse; margin-top: 1rem; background-color: #fff; box-shadow: var(--shadow-main); border-radius: 12px; overflow: hidden; font-size: 0.9rem; }
        .product-table th, .product-table td { padding: 0.8rem 1rem; text-align: left; vertical-align: middle; border-bottom: 1px solid var(--color-border); }
        .product-table th { background-color: #f9f9f9; font-family: var(--font-main); font-weight: 600; }
        .product-table img { width: 50px; height: 50px; object-fit: cover; border-radius: 8px; }
        .product-table .btn { padding: 0.4rem 0.8rem; font-size: 0.8rem; margin-right: 5px; cursor: pointer; border: none; border-radius: 6px; transition: background-color 0.2s; }
        .btn.edit-btn { background-color: #3498db; color: #fff; }
        .btn.edit-btn:hover { background-color: #2980b9; }
        .btn.delete-btn { background-color: #e74c3c; color: #fff; }
        .btn.delete-btn:hover { background-color: #c0392b; }
        .add-form-container { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
        .add-form-container input { padding: 0.6rem; flex-grow: 1; border: 1px solid var(--color-border); border-radius: 8px; }
        .auth-modal.is-visible { opacity: 1; visibility: visible; transform: translate(-50%,-50%) scale(1); }
        #product-modal .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        #product-modal .full-width { grid-column: 1 / -1; }
        #product-modal .form-group label { font-weight: 600; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-top: 1.5rem; }
        .stat-card { background: #fff; padding: 1.5rem; border-radius: 12px; box-shadow: var(--shadow-subtle); }
        .stat-card h4 { font-size: 1rem; color: #555; }
        .stat-card p { font-size: 2rem; font-weight: bold; }
        .stat-card p#stats-total-sales { color: var(--color-primary-start); }
        .status-badge { display: inline-block; padding: 0.3em 0.8em; font-size: 0.8rem; font-weight: 600; border-radius: 20px; margin: 2px; }
        .pagination-container { display: flex; justify-content: center; align-items: center; gap: 0.5rem; padding: 2rem 0; }
        .pagination-btn { border: 1px solid var(--color-border); background-color: #fff; color: var(--color-text-dark); padding: 0.5rem 1rem; cursor: pointer; border-radius: 8px; transition: all 0.3s ease; font-size: 1rem; min-width: 40px; }
        .pagination-btn:hover:not(:disabled) { background-color: var(--color-background-light); border-color: var(--color-primary-start); }
        .pagination-btn.active { background-color: var(--color-primary-start); color: #fff; border-color: var(--color-primary-start); font-weight: bold; cursor: default; }
        .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination-dots { padding: 0.5rem; }
    </style>
</head>
<body class="admin-page">
    
    <div id="admin-auth-layer" style="padding: 2rem; text-align: center; font-size: 1.2rem;">
        <p>Đang kiểm tra quyền truy cập...</p>
    </div>

    <div class="admin-layout protected-content">
        <aside class="admin-sidebar">
            <div class="admin-sidebar-header">
                <h2>SportStore</h2>
            </div>
            <nav class="admin-nav">
                <a href="#dashboard" class="nav-link active" data-target="dashboard">
                    <i class="fas fa-tachometer-alt"></i><span>Bảng Điều Khiển</span>
                </a>
                <div class="nav-group-heading">Bán Hàng</div>
                <a href="#orders" class="nav-link" data-target="orders">
                    <i class="fas fa-file-invoice-dollar"></i><span>Quản Lý Đơn Hàng</span>
                </a>
                <div class="nav-group-heading">Sản Phẩm</div>
                <a href="#products" class="nav-link" data-target="products">
                    <i class="fas fa-box-open"></i><span>Quản Lý Sản Phẩm</span>
                </a>
                <a href="#categories" class="nav-link" data-target="categories">
                     <i class="fas fa-sitemap"></i><span>Quản Lý Danh Mục</span>
                </a>
                <a href="#brands" class="nav-link" data-target="brands">
                    <i class="fas fa-copyright"></i><span>Quản Lý Thương Hiệu</span>
                </a>
                <div class="nav-group-heading">Khách Hàng</div>
                <a href="#users" class="nav-link" data-target="users">
                    <i class="fas fa-users"></i><span>Quản Lý Người Dùng</span>
                </a>
                <a href="/index.html" class="nav-link" style="margin-top: 2rem; opacity: 0.7;">
                     <i class="fas fa-home"></i><span>Về trang chính</span>
                </a>
            </nav>
        </aside>

        <main id="admin-main-content" class="admin-main-content">
            <!-- Nội dung động sẽ được JS chèn vào đây -->
        </main>
    </div>

    <div id="product-modal-overlay" class="page-overlay"></div>
    <div id="product-modal" class="auth-modal" style="display: none; max-width: 800px; max-height: 90vh; overflow-y: auto;">
       <button id="close-product-modal" class="close-auth-modal">×</button>
        <h3 id="product-modal-title">Thêm Sản Phẩm Mới</h3>
        <form id="product-form" class="auth-form">
            <input type="hidden" id="product-id">
            <div class="form-grid">
                <div class="form-group full-width"><label for="product-name">Tên sản phẩm</label><input type="text" id="product-name" required></div>
                <div class="form-group"><label for="product-price">Giá bán (VNĐ)</label><input type="number" id="product-price" required></div>
                <div class="form-group"><label for="product-original-price">Giá gốc</label><input type="number" id="product-original-price"></div>
                <div class="form-group"><label for="product-brandId">Thương Hiệu</label><select id="product-brandId" required></select></div>
                <div class="form-group"><label for="product-categoryId">Danh mục</label><select id="product-categoryId" required></select></div>
                <div class="form-group"><label for="product-countInStock">Tồn kho</label><input type="number" id="product-countInStock" required></div>
                <div class="form-group full-width"><label for="product-image">Link ảnh chính</label><input type="text" id="product-image" required></div>
                <div class="form-group full-width"><label for="product-images">Link ảnh phụ (JSON array)</label><textarea id="product-images" rows="2"></textarea></div>
                <div class="form-group full-width"><label for="product-description">Mô tả ngắn</label><textarea id="product-description" rows="3"></textarea></div>
                <div class="form-group full-width"><label for="product-fullDescription">Mô tả đầy đủ</label><textarea id="product-fullDescription" rows="5"></textarea></div>
                <div class="form-group"><label for="product-warranty">Bảo hành</label><input type="text" id="product-warranty"></div>
                <div class="form-group"><label for="product-youtubeLink">Link Youtube</label><input type="text" id="product-youtubeLink"></div>
                <div class="form-group full-width"><label for="product-specifications">Thông số (JSON)</label><textarea id="product-specifications" rows="5"></textarea></div>
                <div class="form-group full-width" style="display: flex; align-items: center; gap: 10px;"><input type="checkbox" id="product-isPromotional" style="width: auto;"><label for="product-isPromotional" style="margin-bottom: 0;">Là sản phẩm khuyến mãi?</label></div>
            </div>
            <button type="submit" class="btn primary-btn" style="width: 100%; margin-top: 1.5rem;">Lưu Sản Phẩm</button>
        </form>
    </div>

    <script type="module">
        import * as api from './js/api.js';
        import { formatCurrency, showToast } from './js/utils.js';

        document.addEventListener('DOMContentLoaded', () => {
            // === AUTHENTICATION CHECK ===
            const user = JSON.parse(localStorage.getItem('user'));
            const token = localStorage.getItem('token');
            if (!user || user.role !== 'admin' || !token) {
                document.getElementById('admin-auth-layer').innerHTML = '<p style="color: red;">Truy cập bị từ chối. Bạn không phải là Admin hoặc chưa đăng nhập.</p>';
                setTimeout(() => { window.location.href = 'index.html'; }, 2000);
                return;
            }
            document.getElementById('admin-auth-layer').style.display = 'none';
            document.querySelector('.protected-content').style.display = 'flex';

            // === DOM ELEMENTS ===
            const mainContentContainer = document.getElementById('admin-main-content');
            const productModal = document.getElementById('product-modal');
            const productModalOverlay = document.getElementById('product-modal-overlay');
            const productForm = document.getElementById('product-form');

            // === STATE ===
            let currentView = null;

            // === TEMPLATE LOADER ===
            async function loadTemplateIntoMain(viewName) {
                mainContentContainer.innerHTML = `<div class="content-loader"><div class="spinner"></div></div>`;
                try {
                    const response = await fetch(`/templates/admin/${viewName}.html`);
                    if (!response.ok) throw new Error(`Không thể tải template: ${response.statusText}`);
                    mainContentContainer.innerHTML = await response.text();
                    currentView = viewName;
                } catch (error) {
                    mainContentContainer.innerHTML = `<h1 style="color:red;">Lỗi tải trang</h1><p>${error.message}</p>`;
                }
            }
            
            // === RENDER FUNCTIONS ===
            function renderAdminPagination(totalPages, currentPage, containerSelector, targetSection) {
                const container = document.querySelector(containerSelector);
                if (!container) return;
                container.innerHTML = '';
                if (totalPages <= 1) return;
                
                const createButton = (text, page, isActive = false, isDisabled = false) => {
                    const btn = document.createElement('button');
                    btn.innerHTML = text;
                    btn.className = 'pagination-btn';
                    if (isActive) btn.classList.add('active');
                    btn.disabled = isDisabled;
                    btn.dataset.page = page;
                    btn.dataset.target = targetSection;
                    return btn;
                };

                container.appendChild(createButton('«', currentPage - 1, false, currentPage === 1));
                const pagesToShow = [];
                if (totalPages <= 7) {
                    for (let i = 1; i <= totalPages; i++) pagesToShow.push(i);
                } else {
                    pagesToShow.push(1);
                    if (currentPage > 3) pagesToShow.push('...');
                    for (let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) pagesToShow.push(i);
                    if (currentPage < totalPages - 2) pagesToShow.push('...');
                    pagesToShow.push(totalPages);
                }
                pagesToShow.forEach(p => {
                    if (p === '...') {
                        const span = document.createElement('span'); span.textContent = '...'; span.className = 'pagination-dots'; container.appendChild(span);
                    } else { container.appendChild(createButton(p, p, p === currentPage)); }
                });
                container.appendChild(createButton('»', currentPage + 1, false, currentPage === totalPages));
            }

            async function fetchAdminStats() {
                try {
                    const stats = await api.fetchDashboardStats(token);
                    document.getElementById('stats-total-sales').textContent = formatCurrency(stats.totalSales);
                    document.getElementById('stats-total-orders').textContent = stats.totalOrders.toLocaleString('vi-VN');
                    document.getElementById('stats-total-users').textContent = stats.totalUsers.toLocaleString('vi-VN');
                    document.getElementById('stats-total-products').textContent = stats.totalProducts.toLocaleString('vi-VN');
                } catch (error) {
                    if (error.message !== 'Unauthorized') {
                        document.querySelectorAll('.stat-card p').forEach(p => p.textContent = 'Lỗi');
                    }
                }
            }

            async function fetchAndRenderProducts(page = 1) {
                const productListBody = document.getElementById('product-list-body');
                if (!productListBody) return;

                const keyword = document.getElementById('product-search-input')?.value || '';
                const brandId = document.getElementById('product-brand-filter')?.value || '';
                const categoryId = document.getElementById('product-category-filter')?.value || '';

                const params = new URLSearchParams({
                    page: page,
                    pageSize: 10,
                });
                if (keyword) params.append('keyword', keyword);
                if (brandId) params.append('brandId', brandId);
                if (categoryId) params.append('categoryId', categoryId);

                try {
                    const data = await api.fetchProducts(params.toString());
                    if (data && data.products) {
                        productListBody.innerHTML = data.products.map(p => {
                            let statusBadges = '';
                            if (p.isPromotional) {
                                statusBadges += `<span class="status-badge" style="background-color: #f39c12; color: white;">KM</span> `;
                            }
                            if (p.countInStock > 0) {
                                statusBadges += `<span class="status-badge" style="background-color: #27ae60; color: white;">Còn hàng</span>`;
                            } else {
                                statusBadges += `<span class="status-badge" style="background-color: #c0392b; color: white;">Hết hàng</span>`;
                            }

                            return `
                            <tr>
                                <td><img src="${p.image || '/images/placeholder.png'}" alt="${p.name}"></td>
                                <td>${p.name}<br><small style="color:#7f8c8d;">Thương hiệu: ${p.brand || 'N/A'}</small></td>
                                <td>${p.categoryName || 'N/A'}</td>
                                <td>${formatCurrency(p.price)}</td>
                                <td>${p.countInStock}</td>
                                <td>${statusBadges}</td>
                                <td>
                                    <button class="btn edit-btn product-edit-btn" data-id="${p.id}">Sửa</button>
                                    <button class="btn delete-btn product-delete-btn" data-id="${p.id}">Xóa</button>
                                </td>
                            </tr>`;
                        }).join('');
                        renderAdminPagination(data.pages, data.page, '#products-pagination-container', 'products');
                    }
                } catch (error) {
                    if (error.message !== 'Unauthorized' && productListBody) {
                        productListBody.innerHTML = `<tr><td colspan="7" style="text-align: center;">Lỗi tải sản phẩm: ${error.message}</td></tr>`;
                    }
                }
            }
            
            async function fetchAndRenderCategories() {
                 const categoryListBody = document.getElementById('category-list-body');
                if (!categoryListBody) return;
                try {
                    const categories = await api.fetchCategories();
                    categoryListBody.innerHTML = categories.map(c => `
                        <tr data-id="${c.id}">
                            <td>${c.id}</td><td class="editable-name">${c.name}</td><td>${c.productCount}</td>
                            <td><button class="btn edit-btn category-edit-btn">Sửa</button><button class="btn delete-btn category-delete-btn" data-id="${c.id}">Xóa</button></td>
                        </tr>`).join('');
                } catch (error) {
                    if (error.message !== 'Unauthorized' && categoryListBody) {
                        categoryListBody.innerHTML = `<tr><td colspan="4" style="text-align: center;">${error.message}</td></tr>`;
                    }
                }
            }

            async function fetchAndRenderBrands() {
                const brandListBody = document.getElementById('brand-list-body');
                if (!brandListBody) return;
                try {
                    const brands = await api.fetchBrands();
                    brandListBody.innerHTML = brands.map(b => `
                        <tr data-id="${b.id}">
                            <td>${b.id}</td><td class="editable-name">${b.name}</td><td>${b.productCount}</td>
                            <td><button class="btn edit-btn brand-edit-btn">Sửa</button><button class="btn delete-btn brand-delete-btn" data-id="${b.id}">Xóa</button></td>
                        </tr>`).join('');
                } catch (error) {
                    if (error.message !== 'Unauthorized' && brandListBody) {
                        brandListBody.innerHTML = `<tr><td colspan="4" style="text-align: center;">${error.message}</td></tr>`;
                    }
                }
            }
            
            // Tương tự cho fetchAndRenderUsers và fetchAndRenderOrders
            // ...

            // === MODAL & FORM HANDLERS (IMPROVED & FIXED) ===
            async function openProductModal(product = null) {
                productForm.reset();
                productModalOverlay.classList.add('is-visible');
                productModal.style.display = 'block';
                setTimeout(() => productModal.classList.add('is-visible'), 10);
                document.getElementById('product-modal-title').textContent = 'Đang tải dữ liệu...';

                const brandSelect = document.getElementById('product-brandId');
                const categorySelect = document.getElementById('product-categoryId');
                brandSelect.innerHTML = '<option value="">Đang tải...</option>';
                categorySelect.innerHTML = '<option value="">Đang tải...</option>';
                brandSelect.disabled = true;
                categorySelect.disabled = true;

                try {
                    const results = await Promise.allSettled([ api.fetchBrands(), api.fetchCategories() ]);
                    const brandsResult = results[0];
                    const categoriesResult = results[1];

                    if (brandsResult.status === 'fulfilled') {
                        brandSelect.innerHTML = '<option value="">-- Chọn thương hiệu --</option>' + brandsResult.value.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
                        brandSelect.disabled = false;
                    } else {
                        brandSelect.innerHTML = '<option value="">Lỗi tải thương hiệu</option>';
                        showToast('Không thể tải danh sách thương hiệu!', 'error');
                    }

                    if (categoriesResult.status === 'fulfilled') {
                        categorySelect.innerHTML = '<option value="">-- Chọn danh mục --</option>' + categoriesResult.value.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                        categorySelect.disabled = false;
                    } else {
                        categorySelect.innerHTML = '<option value="">Lỗi tải danh mục</option>';
                        showToast('Không thể tải danh sách danh mục!', 'error');
                    }
                    
                    if (product) {
                        document.getElementById('product-modal-title').textContent = 'Chỉnh Sửa Sản Phẩm';
                        document.getElementById('product-id').value = product.id;
                        document.getElementById('product-name').value = product.name || '';
                        document.getElementById('product-price').value = product.price || 0;
                        document.getElementById('product-original-price').value = product.originalPrice || '';
                        document.getElementById('product-countInStock').value = product.countInStock || 0;
                        document.getElementById('product-image').value = product.image || '';
                        document.getElementById('product-images').value = product.images ? JSON.stringify(product.images, null, 2) : '[]';
                        document.getElementById('product-description').value = product.description || '';
                        document.getElementById('product-fullDescription').value = product.fullDescription || '';
                        document.getElementById('product-warranty').value = product.warranty || '';
                        document.getElementById('product-youtubeLink').value = product.youtubeLink || '';
                        document.getElementById('product-specifications').value = product.specifications ? JSON.stringify(product.specifications, null, 2) : '[]';
                        document.getElementById('product-isPromotional').checked = product.isPromotional || false;
                        if (brandsResult.status === 'fulfilled') brandSelect.value = product.brandId || '';
                        if (categoriesResult.status === 'fulfilled') categorySelect.value = product.categoryId || '';
                    } else { 
                        document.getElementById('product-modal-title').textContent = 'Thêm Sản Phẩm Mới';
                        document.getElementById('product-images').value = '[]';
                        document.getElementById('product-specifications').value = '[]';
                    }
                } catch (error) {
                    console.error("Lỗi không xác định khi mở form sản phẩm:", error);
                    if (error.message !== 'Unauthorized') showToast('Đã có lỗi xảy ra. Vui lòng thử lại.', 'error');
                }
            }

            function closeProductModal() {
                 productModal.classList.remove('is-visible');
                 setTimeout(() => { 
                    productModalOverlay.classList.remove('is-visible'); 
                    productModal.style.display = 'none'; 
                }, 300);
            }

            async function onProductFormSubmit(e) {
                e.preventDefault();
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.textContent;
                submitBtn.disabled = true; 
                submitBtn.textContent = 'Đang lưu...';
                
                const id = document.getElementById('product-id').value;
                const originalPriceValue = document.getElementById('product-original-price').value;

                const productData = {
                    name: document.getElementById('product-name').value.trim(),
                    price: parseFloat(document.getElementById('product-price').value),
                    originalPrice: originalPriceValue ? parseFloat(originalPriceValue) : null,
                    brandId: document.getElementById('product-brandId').value,
                    categoryId: document.getElementById('product-categoryId').value,
                    countInStock: parseInt(document.getElementById('product-countInStock').value, 10),
                    image: document.getElementById('product-image').value.trim(),
                    images: document.getElementById('product-images').value.trim(),
                    description: document.getElementById('product-description').value.trim(),
                    fullDescription: document.getElementById('product-fullDescription').value.trim(),
                    warranty: document.getElementById('product-warranty').value.trim(),
                    youtubeLink: document.getElementById('product-youtubeLink').value.trim(),
                    specifications: document.getElementById('product-specifications').value.trim(),
                    isPromotional: document.getElementById('product-isPromotional').checked
                };

                if (!productData.name || !productData.brandId || !productData.categoryId) {
                    showToast('Vui lòng điền Tên sản phẩm, Thương hiệu và Danh mục.', 'error');
                    submitBtn.disabled = false; 
                    submitBtn.textContent = originalBtnText;
                    return;
                }

                try {
                    if (id) { 
                        await api.updateProduct(id, productData, token); 
                        showToast('Cập nhật sản phẩm thành công!', 'success'); 
                    } else { 
                        await api.createProduct(productData, token); 
                        showToast('Thêm sản phẩm thành công!', 'success'); 
                    }
                    closeProductModal();
                    const currentPage = document.querySelector('#products-pagination-container .active')?.dataset.page || 1;
                    fetchAndRenderProducts(currentPage);
                } catch (error) { 
                    if (error.message !== 'Unauthorized') showToast(`Lỗi: ${error.message}`, 'error');
                } finally { 
                    submitBtn.disabled = false; 
                    submitBtn.textContent = originalBtnText;
                }
            }
            
            // === EVENT HANDLER & ROUTER (IMPROVED) ===
            async function handleViewChange(viewName) {
                if (currentView === viewName) return; 
                await loadTemplateIntoMain(viewName);
                
                switch(viewName) {
                    case 'dashboard': fetchAdminStats(); break;
                    case 'products':
                        const brandSelect = document.getElementById('product-brand-filter');
                        const categorySelect = document.getElementById('product-category-filter');
                        Promise.all([api.fetchBrands(), api.fetchCategories()]).then(([brands, categories]) => {
                            if (brandSelect) {
                                brands.forEach(b => brandSelect.add(new Option(b.name, b.id)));
                            }
                            if (categorySelect) {
                                categories.forEach(c => categorySelect.add(new Option(c.name, c.id)));
                            }
                        }).catch(err => showToast('Lỗi tải dữ liệu bộ lọc', 'error'));
                        
                        document.getElementById('apply-product-filters-btn')?.addEventListener('click', () => {
                            fetchAndRenderProducts(1);
                        });
                        
                        fetchAndRenderProducts(1); 
                        break;
                    case 'categories': fetchAndRenderCategories(); break;
                    case 'brands': fetchAndRenderBrands(); break;
                    // ... Thêm case cho users và orders nếu cần
                }
            }

            function setupEventListeners() {
                document.body.addEventListener('click', async (e) => {
                    const target = e.target;
                    const closest = (selector) => target.closest(selector);
                    
                    const navLink = closest('.admin-nav .nav-link');
                    if (navLink && !navLink.href.endsWith('/index.html')) {
                        e.preventDefault();
                        const targetView = navLink.dataset.target;
                        if (currentView !== targetView) {
                            document.querySelectorAll('.admin-nav .nav-link').forEach(l => l.classList.remove('active'));
                            navLink.classList.add('active');
                            window.location.hash = targetView;
                            handleViewChange(targetView);
                        }
                        return;
                    }

                    if (closest('#add-product-btn')) { 
                        openProductModal();
                        return; 
                    }
                    if (target.id === 'close-product-modal' || target.id === 'product-modal-overlay') { 
                        closeProductModal(); 
                        return;
                    }
                    
                    const editProductBtn = closest('.product-edit-btn');
                    if (editProductBtn) {
                        editProductBtn.textContent = '...'; 
                        editProductBtn.disabled = true;
                        try { 
                            const product = await api.fetchProductById(editProductBtn.dataset.id); 
                            openProductModal(product); 
                        } 
                        catch(error) { if (error.message !== 'Unauthorized') showToast(`Lỗi: ${error.message}`, 'error'); } 
                        finally { 
                            if (editProductBtn) {
                                editProductBtn.textContent = 'Sửa'; 
                                editProductBtn.disabled = false;
                            }
                        }
                        return;
                    }

                    const deleteProductBtn = closest('.product-delete-btn');
                    if (deleteProductBtn) {
                        if (confirm('Xóa sản phẩm này?')) {
                            try { 
                                await api.deleteProduct(deleteProductBtn.dataset.id, token); 
                                showToast('Xóa thành công'); 
                                const currentPage = document.querySelector('#products-pagination-container .active')?.dataset.page || 1;
                                fetchAndRenderProducts(currentPage);
                                fetchAdminStats(); 
                            } 
                            catch (error) { if (error.message !== 'Unauthorized') showToast(`Lỗi: ${error.message}`, 'error'); }
                        }
                        return;
                    }
                    
                    const paginationBtn = closest('.pagination-btn');
                    if (paginationBtn && !paginationBtn.disabled && !paginationBtn.classList.contains('active')) {
                        const page = Number(paginationBtn.dataset.page);
                        const targetSection = paginationBtn.dataset.target;
                        if (targetSection === 'products') fetchAndRenderProducts(page);
                        // thêm if cho các mục phân trang khác
                        return;
                    }

                });
                
               document.body.addEventListener('submit', (e) => {
                    if (e.target.id === 'product-form') {
                        onProductFormSubmit(e);
                    }
                });
            }

            function initializePage() {
                setupEventListeners();
                const viewNameFromHash = window.location.hash.substring(1);
                const initialView = ['dashboard', 'products', 'categories', 'brands', 'orders', 'users'].includes(viewNameFromHash) ? viewNameFromHash : 'dashboard';
                
                const activeLink = document.querySelector(`.admin-nav a[data-target="${initialView}"]`);
                if (activeLink) {
                    activeLink.click();
                } else {
                    document.querySelector('.admin-nav a[data-target="dashboard"]').click();
                }
            }

            initializePage();
        });
    </script>

    <div id="toast-notification" class="toast"><span id="toast-message"></span></div>

</body>
</html>